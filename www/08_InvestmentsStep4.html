<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <!--Import Google Icon Font-->
  <link href="assets/css/icon.css?family=Material+Icons" rel="stylesheet">

  <!--Import materialize.css-->
  <link type="text/css" rel="stylesheet" href="assets/css/materialize.min.css"  media="screen,projection"/>
  <!--Import my style-->
  <link type="text/css" href="assets/css/custom.css" rel="stylesheet"/>
  <link type="text/css" href="assets/css/nouislider.min.css" rel="stylesheet"/>
  <!--Let browser know website is optimized for mobile-->
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
</head>

<body class="profile settings-investment" oncontextmenu="return false">
  <!--Nav Main-->
  <div class="navbar-fixed nav-descktop"></div>

  <!--Nav Responsive-->
  <nav class="nav-app">
    <div class="nav-wrapper">
      <a href="#!" class="brand-logo center">En negociación con <span class="negociando-con"></span></a>
      <ul class="left ">
        <li><a href="08_InvestmentsStep3.html?section=negociar"><i class="material-icons">keyboard_arrow_left</i></a></li>
      </ul>
      <ul class="right ">
        <li><a href="#!" class="red-text tooltipped eliminar" data-position="top" data-delay="50" data-tooltip="Eliminar proyecto"><i class="material-icons">cancel</i></a></li>
      </ul>
    </div>
  </nav>
  <div class="progress">
    <div class="indeterminate"></div>
  </div> 
  <div class="wrapper">
    <div class="container box-messages">
      <div class="row">
        <div class="col s12 pag-nav">
          <span class="btn-nav-pag">
            <a href="#!" class="btn grey lighten-1"><i class="material-icons left">&nbsp;</i>Volver</a>   
            <a href="08_InvestmentsStep3.html" class="btn grey lighten-1">Buscar proyecto</a>                         
          </span>
        </div>
        <div class="col s12">    
          <h3 class="center hide-on-med-and-down names">En negociación con <span class="negociando-con"></span></h3>
          <br>
        </div>         

        <div class="col s12">
          <div class="col s12">
            <div class="box-proyect-nego">                    
              <div class="row">  
                <div class="col s7">
                  <a href="#!user" class="avatar-nego"><img class="circle photo" src="assets/images/avatarUser.jpg"></a>
                  <div class="info-nego">
                    <h5 class="negociando-con gComments"></h5>  
                    <p><span class="destination"></span><span class="interest"></span><span class="duration"></span></p> 
                    <div class="star-user gComments"></div>
                  </div>                                                           
                </div> 
                <div class="col s5 right-align">                                 
                  <h3 class="amount"></h3>
                  <p><small>Recibo Mensual: <span class="cuota"></span><br/><b>Recibo Total: <span class="pago_total"></span></b><br>Oferta #<span class="id_ofert"></span></small></p>                    
                </div>  
                <div class="col s12">
                  <input id="prest_b" name="prest_b" type="hidden" value="">
                  <input id="uuid_prest" name="uuid_prest" type="hidden" value="">
                  <input id="total_b" name="total_b" type="hidden" value="">
                  <input id="quota_b" name="quota_b" type="hidden" value="">
                  <input id="interes_b" name="interes_b" type="hidden" value="">
                  <input id="plazo_b" name="plazo_b" type="hidden" value="">
                  <input id="destination_b" name="destination_b" type="hidden" value="">
                  <input id="offer_b" name="offer_b" type="hidden" value="">
                  <hr style="width: 90%">
                </div>
              </div>                     
            </div>
          </div>
        </div>                     
      </div>
      <div class="chat"></div>
      <div class="clear"></div> 
    </div>                         

    <div class="box-businnes"> 
      <div class="btn-action-bussines">
        <a href="#modal3" class="btn-nego">Negociar</a>
        <a href="#!" class="btn-aceptar">Aceptar</a>
      </div>
      <div class="info-money">
        Tu saldo es: <strong>$<span class="saldo-inversionista"></span></strong>
      </div> 
    </div>                                                                                

  </div>         

  <!-- Modal Structure Load -->
  <div id="modal3" class="modal">
    <a href="#!" class="modal-action modal-close"><i class="material-icons close">close</i></a>
    <div class="modal-content content-done valign-wrapper">  
      <div class="row content-modal">            
        <div class="col s12">
          <p>Configura las nuevas características para renegociar tu inversión.</p>  

          <div class="card-panel white">
            <p class="range-field"><div id="interest"></div></p> 
            <input type="hidden" id="monto" name="monto" value="">
            <input type="hidden" id="interes" name="interes" value="">
            <input type="hidden" id="interesF" name="interesF" value="">
            <div class="clear"></div>
            <h5 class="left"><small>Interes:</small> <strong><span class="interes1"></span> - <span class="interes2"></span> % E.M.</strong></h5> 
            <p>&nbsp;</p>
          </div>         

          <div class="card-panel white">
            <p class="range-field"><div id="duration"></div></p>
            <input type="hidden" id="duracion" name="duracion" value=""> 
            <input type="hidden" id="duracionF" name="duracionF" value="">
            <input type="hidden" id="negociando-con" name="negociando-con" value="">
            <div class="clear"></div>
            <h5 class="left"><small>Duración:</small> <strong><span class="duracion1"></span> - <span class="duracion2"></span> Meses</strong></h5>
            <p>&nbsp;</p>    
          </div>       

        </div>

        <div class="col s12 center payment-month">
          <p>Pago (mes)</p>
          <h2>$<span class="cuotaSlider"></span></h2>
        </div>

        <div class="col s12 center margin-top-40 btn-register">
          <a class="waves-effect waves-light green accent-4 btn-large negociar">Negociar</a>
        </div>                    
      </div>
    </div>  
  </div>

  <!-- Modal Structure Agree -->
  <div id="info2" class="modal">
    <div class="modal-content">
      <h4>Adcionar Favoritos</h4>
      <p>La negociación ha sido adicionada a favoritos.</p>
    </div>
    <div class="modal-footer">
      <a href="#!" class="modal-action modal-close waves-effect waves-green btn-flat">Aceptar</a>
    </div>
  </div>  
  <div id="modal4" class="modal">
    <a href="#!" class="modal-action modal-close"><i class="material-icons close">close</i></a>
    <div class="modal-content content-done valign-wrapper">            
      <div class="container" style="padding-top:65%;">                
        <div class="icon-donde"><i class="material-icons done">done</i></div>
        <h4>En hora buena!</h4>
        <p>Trato aceptado con <span class="negociando-con"></span></p>
        <hr>
        <div class="row content-msg">
          <div class="col s12"><p>Hola <span class="names"></span>, para completar tu inversión debes seguir estos pasos en las próximas 24 horas:</p><p>1) Consignar en la cuenta #<span class="cuenta"></span> <span class="tipo_cuenta"></span>, banco <span class="banco"></span> el valor de <span class="amount"></span><br/>2) En la consignación debes adicionar el siguiente código NEG<span class="id_b"></span><br/>3) A partir del siguiente mes recibirás la suma de <span class="cuotaF"></span> durante <span class="durationF"></span>, al final de los meses negociados recibirás <span class="pago_totalF"></span>.<br/>4) Recuerda que si no consignas el valor de dinero en el tiempo estipulado el negocio no será válido. Esto claramente perjudica tu puntuación dentro de la comunidad BankU.</p><p>Te invitamos a seguir invirtiendo y agrandando tu portafolio de inversión, si tienes alguna duda puedes escribirnos en la sesión de quejas y reclamos con el número de tu transacción</p></div> 
        </div>
      </div>
    </div>
  </div>
  <div id="modal5" class="modal">
    <a href="#!" class="modal-action modal-close"><i class="material-icons close">close</i></a>
    <div class="modal-content content-done valign-wrapper">            
      <div class="card-panel grey lighten-5 z-depth-1"> 
        <div class="container">  
          <div class="row">
            <div class="col s9 m8 l10 left-align">
              <a href="#!">
                <h4 class="margin-bottom-0 negociando-con"></h4>
              </a>
              <div class="star-user"></div>
            </div>
          </div>
          <div class="row">
            <div class="col s12 center">                                   
              <div class="divider"></div>
              <div class="row">
                <div class="col s12 left-align">
                 <p class="grey-text center-align">Comentarios</p>
                 <div class="getComments"></div>
                 <p class="center-align more-comments">
                  <a class="grey-text" href="#" class="show-comments">Ver todos los comentarios</a>
                </p>
              </div>                                   
            </div>                                                                                                     
          </div>
        </div>  
      </div>
    </div>
  </div>
</div>    

<footer class="page-footer">
  <div class="footer-copyright">
    <div class="container">
      © 2017 BankU                    
    </div>
    <input type="hidden" id="config" name="config" value="">
  </div>
</footer>           
<script type="text/javascript" src="cordova.js"></script>
<script type="text/javascript" src="index.js"></script> 
<!--Import jQuery before materialize.js-->
<script type="text/javascript" src="assets/js/jquery-2.1.1.min.js"></script>
<script type="text/javascript" src="assets/js/materialize.min.js"></script>
<script type="text/javascript" src="assets/js/jquery.validate.min.js"></script>
<script type="text/javascript" src="assets/js/numeral.min.js"></script>
<script type="text/javascript" src="assets/js/CryptoJS/aes.js"></script>
<script type="text/javascript" src="assets/js/CryptoJS/aes-json-format.js"></script>  
<script src="assets/js/socket.io.js"></script>
<script type="text/javascript" src="assets/js/tools.js?v=1.0.0"></script>         
<script type="text/javascript" src="assets/js/includes.js?v=1.0.0"></script> 
<script type="text/javascript" src="assets/js/nouislider.min.js"></script> 
<script type="text/javascript" src="assets/js/wNumb.js"></script>     
<script type="text/javascript">
 $( document ).ready(function(){     
  const socket = io('https://banku-services.herokuapp.com/');
  $('.tooltipped').tooltip({delay: 50});
  $(".wrapper").show(); 
  var id_ofert= getUrlParameter("id_ofert");
  $(".id_ofert").html(id_ofert);
  if(id_ofert){
    getHeaderOffert(id_ofert);
    getOffersTemp(id_ofert);
  } 

  getFavorite(id_ofert,encodeURIComponent(localStorage.data),localStorage.type_user);

  $( ".btn-aceptar" ).click(function() {
    $(".btn-action-bussines").hide();
    var monto= $("#total_b").val();
    var interes= $("#interes_b").val();
    if($(".l_interes").first().html())interes= $(".l_interes").first().html();
    var duracion= $("#plazo_b").val();
    if($(".l_duracion").first().html())duracion= $(".l_duracion").first().html();
    var cuota= calcCuota(monto,interes,duracion);
    $(".f_cuota").html(numeral(cuota).format('0,0'));   
    
    $(".cuotaF").html("$"+numeral(cuota).format('0,0'));
    $(".durationF").html(duracion+" Meses");
    $(".pago_totalF").html("$"+numeral(cuota * duracion).format('0,0'));

    var prest_b= cryptData($("#prest_b").val());
    var localdata= JSON.parse(decryptData(localStorage.configs));
    $.ajax({
      type: "POST",
      url: "https://bankucolombia.com/lib/ajax_service_mobil.php",
      data: "action=setOfferFinal&inv_b="+encodeURIComponent(localStorage.data)+"&prest_b="+encodeURIComponent(prest_b)+"&total_b="+monto+"&quota_b="+cuota+"&interes_b="+$("#interes_b").val()+"&plazo_b="+duracion+"&destination_b="+$("#destination_b").val()+"&offer_b="+id_ofert+"&admin="+encodeURIComponent(localStorage.data),
      dataType:'JSON',
      success: function(msg){
        if(msg.status){                
          var id_b= msg.id_b;
          $(".id_b").html(setDigits(id_b,4));
          showMsgConfirm();
          $.ajax({
            type: "POST",
            url: "https://bankucolombia.com/lib/ajax_service_mobil.php",
            data: "action=setPaysxBusiness&fecha="+localdata.fecha+"&prest="+encodeURIComponent(cryptData($("#prest_b").val()))+"&monto="+$("#total_b").val()+"&quota_b="+$("#quota_b").val()+"&tasa1="+$("#interes_b").val()+"&meses="+$("#plazo_b").val()+"&id_b="+id_b,
            dataType:'JSON',
            success: function(msg){
              if(msg.status){                      
                var obj = jQuery.parseJSON ( getOnline($("#prest_b").val()) );
                if(obj.online=="0"){
                  sendPushMessage(obj.pushtoken,"Aceptación de negociación en el sistema BankU.");
                }else{
                  var data = {page:"12_PaymentsStep2.html?section=mis_pagos&msg=aceptada",action:"new_business",id_u:$("#negociando-con").val()};
                  socket.emit('setOffert', data);                          
                }             
              }
            }
          });             
        }
      }
    });
  });      
  $( ".eliminar" ).click(function() {
    var conf=confirm("¿Está seguro de que desea eliminar esta negociación?");
    if(conf){
      $.ajax({
        type: "POST",
        url: "https://bankucolombia.com/lib/ajax_service_mobil.php",
        data: "action=delOfferMatch&inv="+encodeURIComponent(localStorage.data)+"&id="+id_ofert+"&owner_offer="+encodeURIComponent(cryptData($("#prest_b").val())),
        dataType:'JSON',
        success: function(msg){  
          if(msg.status){
            var data = {page:"10_LoansStep1.html?section=mis_proyectos",action:"del_offert",id_ofert:id_ofert,id_u:$("#prest_b").val()};                    
            socket.emit('setOffert', data);             
            window.location.href = "08_InvestmentsStep3.html?section=negociar";
          }
        }
      });          
    }
  });
  $( ".gComments" ).click(function() {
    $('#modal5').modal('open');
  });       
  $( ".btn-favorito" ).click(function() {
    $.ajax({
      type: "POST",
      url: "https://bankucolombia.com/lib/ajax_service_mobil.php",
      data: "action=setFavorite&admin="+encodeURIComponent(localStorage.data)+"&inv="+encodeURIComponent(localStorage.data)+"&prest="+$("#prest_b").val()+"&id="+id_ofert,
      dataType:'JSON',
      success: function(msg){  
        if(msg.status){
          $(".btn-favorito").css("background-position","right -2px bottom 21px").css("color","#fed22c");
          $('#info2').modal('open');
        }
      }
    });
  });      
  $( ".negociar" ).click(function() {
    $(".btn-register").html('<img src="assets/images/ajax-loader.gif" alt="Procesando...">');
    var monto= $("#monto").val();
    var interes= $("#interes").val();
    var duracion= $("#duracion").val();         
    if(monto!=""&&interes!=""&&duracion!=""){      
      var setoffer= setOfferTemp(id_ofert,localStorage.data,cryptData($("#prest_b").val()),interes,duracion);
      if(setoffer){
        $(".btn-nego,.btn-aceptar").hide();
        var redir= "10_LoansStep4.html?section=solicitar_dinero&id_ofert="+id_ofert+"&negociando=true";
        var data = {page: redir,action:"chat",id_u:$("#prest_b").val()};
        socket.emit('setOffert',data);
        
        var obj = jQuery.parseJSON ( getOnline($("#prest_b").val()) );
        if(obj.online=="0"){
          sendPushMessage(obj.pushtoken,'Nuevo solicitud del usuario '+$(".nombre-user").html()+'.');
        }
        location.reload();
      }
    }
  });             
})
function setValues(){
  if($(".l_interes").first().html())$("#interesF").val($(".l_interes").first().html());
  if($(".l_plazo").first().html())$("#duracionF").val($(".l_plazo").first().html());
  setSliders();
}
function setSliders(){
  var data= JSON.parse(decryptData(localStorage.configs));
  var monto= $("#monto").val();
  var interes= $("#interes").val();
  if($("#interesF").val()!=""){
    interes= $("#interesF").val();
        //$(".interest").html(interes+"% | ");
      }
      var duracion= $("#duracion").val();
      if($("#duracionF").val()!=""){
        duracion= $("#duracionF").val();
        //$(".duration").html(duracion+" Meses");  
      }   
      console.log(monto+"-"+interes+"-"+duracion);
      var cuota= calcCuota(monto,interes,duracion);
      $(".cuotaSlider").html(numeral(cuota).format('0,0'));
      //$(".cuota").html("$"+numeral(cuota).format('0,0'));      
      //$(".pago_total").html("$"+numeral(cuota*duracion).format('0,0'));      

      var find = ["$","%","."];
      var replace = ['','',''];
      noUiSlider.create(interest, {
        start: [ interes ],
        connect: true,
        tooltips: [ true ],
        range: {
          'min': parseFloat(data.interes1),
          'max': parseFloat(data.interes2)
        },
        format: wNumb({
          decimals: 2,
          mark: '.',
          suffix: '%',
        }) 
      });
      interest.noUiSlider.on('change', function(data){
        //$(".cuota").html("0");
        if(monto!=""&&interes!=""&&duracion!=""&&monto!="0"&&interes!="0"&&duracion!="0"){
          var interes= rplPerc(data.toString());
          var duracion= duration.noUiSlider.get();          
          $("#interes").val(interes);
          $("#duracion").val(duracion);
          var cuota= calcCuota(monto,interes,duracion);
          $(".cuotaSlider").html(numeral(cuota).format('0,0'));
        }
      });        
      noUiSlider.create(duration, {
        start: [ duracion ],
        connect: true,
        tooltips: [ true ],
        range: {
          'min': parseInt(data.duracion1),
          'max': parseInt(data.duracion2)
        },
        format: wNumb({
          decimals: 0
        })             
      });
      duration.noUiSlider.on('change', function(data){
        //$(".cuota").html("0");
        if(monto!=""&&interes!=""&&duracion!=""&&monto!="0"&&interes!="0"&&duracion!="0"){
          var interes= rplPerc(interest.noUiSlider.get());
          var duracion= data.toString();
          $("#interes").val(interes);
          $("#duracion").val(duracion);          
          var cuota= calcCuota(monto,interes,duracion);
          $(".cuotaSlider").html(numeral(cuota).format('0,0'));
        }
      });
      if($(".user_id").attr("data-id")){
        //alert($(".user_id").attr("data-id")+" - "+decryptData(localStorage.data));                   
        if($(".user_id").attr("data-id") != decryptData(localStorage.data)){
          $(".btn-nego,.btn-aceptar").css('display','inline-block');
        }else{
          $(".btn-nego,.btn-aceptar").css('display','none');
        }           
      }else{
        $(".btn-nego,.btn-aceptar").css('display','inline-block');
      }
      if(interes&&duracion){
        $(".btn-action-bussines").show();
      }else{        
        location.reload();
      }
    }
    function getHeaderOffert(id_ofert){
     $.ajax({
      type: "POST",
      url: "https://bankucolombia.com/lib/ajax_service_mobil.php",
      data: "action=getHeaderOffert&id_ofert="+id_ofert,
      async:false,
      dataType:'JSON',
      success: function(msg){    
        if(msg.status&&msg.data){
          var data= JSON.parse(decryptData(localStorage.configs));
          $.each(msg.data, function( index, value ) {
            var monto= parseInt(data.amount);
            var interes= parseFloat(data.interest);
            var duracion= parseInt(data.duration);                  
            
            //alert(decryptData(localStorage.data)+"!="+value.id_u);
            if(decryptData(localStorage.data)!=value.id_u){
              $(".avatar-nego").hide();
              $(".nombre-user").html(value.user_u);
              $("#negociando-con").val(value.id_u);
              $(".negociando-con").html(value.user_u);
              $("#prest_b").val(value.id_u);
              $(".tipo_cuenta").html(value.tipo_cuenta);
              $(".cuenta").html(value.cuenta);
              $(".banco").html(value.banco);
              monto= parseInt(value.amount);
              interes= parseFloat(value.interest);
              duracion= parseInt(value.duration);                    
            }
            
            var starts= getStarts(value.calification2_u);
            $(".star-user").html(starts);
            var cuota= calcCuota(monto,interes,duracion);
            var calification= value.calification;                  

            if(localStorage.type_user!="prestatario"&&value.ldestination)$(".destination").html(value.ldestination+'<br>');
            $(".interest").html(interes+'% | ');
            if($("#interesF").val()=="")$("#interesF").val(interes);
            $(".duration").html(duracion+' Meses');
            if($("#duracionF").val()=="")$("#duracionF").val(duracion);
            $(".amount").html("$"+numeral(monto).format('0,0'));
            $(".cuota").html("$"+numeral(cuota).format('0,0'));
            $(".pago_total").html("$"+numeral((cuota * duracion)).format('0,0'));
            $("#monto").val(monto);
            $("#interes").val(interes);
            $("#duracion").val(duracion);
            $("#total_b").val(monto);
            $("#quota_b").val(cuota);
            $("#interes_b").val(interes);
            $("#destination_b").val(value.destination);                  
            $("#plazo_b").val(duracion);
            $("#offer_b").val(id_ofert);
            $("#inv_b").val(decryptData(localStorage.data));
          });                
        }
      }
    });  
   }

   function showMsgConfirm(){  
    var negociando= $("#negociando-con").val();
    $('#modal4').modal('open',{
      dismissible: true,
      complete: function() {
        window.location.href = "11_EarningsStep1.html?section=mis_ganancias";
      }
    });
  }          
</script>
</body>
</html>