<!DOCTYPE html>
 <html lang="en">
    <head>
        <meta charset="utf-8">
        <!--Import Google Icon Font-->
        <link href="assets/css/icon.css?family=Material+Icons" rel="stylesheet">
        
        <!--Import materialize.css-->
        <link type="text/css" rel="stylesheet" href="assets/css/materialize.min.css"  media="screen,projection"/>
        <!--Import my style-->
        <link type="text/css" href="assets/css/custom.css" rel="stylesheet"/>
        <link type="text/css" href="assets/css/nouislider.min.css" rel="stylesheet"/>
        <!--Let browser know website is optimized for mobile-->
        <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    </head>

    <body class="profile settings-investment">
    <!--Nav Main-->
    <div class="navbar-fixed nav-descktop"></div>

        <!--Nav Responsive-->
        <nav class="nav-app">
            <div class="nav-wrapper">
                <a href="#!" class="brand-logo center">Configuración de mi proyecto</a>
                <ul class="left ">
                    <li><a href="#!" class="back"><i class="material-icons">keyboard_arrow_left</i></a></li>
                </ul>
            </div>
        </nav>

        <div class="wrapper">
        <form id="frm_register" action="#">
            <div class="container">
                <div class="row">
                    <div class="col s12 pag-nav">
                        <span class="btn-nav-pag">
                            <a href="#!" class="btn grey lighten-1 back"><i class="material-icons left">&nbsp;</i>Volver</a>                            
                        </span>
                    </div>
                    <div class="col s12">          
                        <h3 class="center hide-on-med-and-down">Configuración de mi proyecto</h3>
                        <br>
                        <p class="txt-msg">• Configura las características de tu proyecto.<br></p>
                        <p>&nbsp;</p>                                           
                    </div>  
                </div>
            </div>                  
            <div class="col s12 m5 configuration">
                <div class="card-panel white">
                    <div class="container">
                        <div class="row">
                            <div class="col s10 offset-s1">                                    
                                    <div id="capital"></div>
                                    <h6><small>Monto a prestar:</small> 2 - 6 Mill.</h6>
                                    <input type="hidden" id="monto" name="monto" value="2000000">
                            </div>
                        </div>                                            
                    </div>
                </div>
                <div class="card-panel white">
                    <div class="container">
                        <div class="row">
                            <div class="col s10 offset-s1">                                    
                                    <div id="interest"></div>
                                    <h6><small>Interés a pagar:</small> 0,8 - 2,3 % E.M.</h6>
                                    <input type="hidden" id="interes" name="interes" value="0.8">
                            </div>
                        </div>                                            
                    </div>
                </div>
                <div class="card-panel white">
                    <div class="container">
                        <div class="row">
                            <div class="col s10 offset-s1">                                    
                                    <div id="duration"></div>
                                    <h6><small>Duración del préstamo:</small> 0 - 12 Meses</h6>
                                    <input type="hidden" id="duracion" name="duracion" value="6">
                                    <input type="hidden" id="action" name="action" value="setDataBusinnes">
                                    <input type="hidden" id="type" name="type" value="">
                                    <input type="hidden" id="id_u" name="id_u" value="">
                            </div>
                        </div>                                            
                    </div>
                </div>
            </div>
            <div class="container configuration">
                <div class="row">
                    <div class="col s10 offset-s1 margin-top-40">
                        <div class="input-field col s12">
                            <select id="motivo" name="motivo" class="form-control">
                                <option value="" selected>Selecciona uno</option>
                                <option value="791">Educación</option>
                                <option value="792">Libre Inversión</option>
                                <option value="793">Vivienda</option>
                                <option value="794">Vehículo</option>
                                <option value="795">Viajes/Recreación</option>
                              </select>
                            <label>Tipo de préstamo</label>
                        </div>
                    </div>
                    <div class="col s12 center payment-month">
                        <p>Pago (mes)</p>
                        <h2>$<span class="cuota">0</span></h2>
                    </div>
                </div>
            </div>
            <div class="container margin-top-40 configuration">  
                <div class="row"> 
                    <div class="col s12 center margin-top-40 btn-register btn-find-proyects">
                        <a href="#!" class="waves-effect waves-light green accent-4 btn-large">Guardar y solicitar préstamos</a>
                    </div> 
                </div>                                                                                
            </div>
        </form>
        </div>  

        <!-- Modal Structure Load -->
        <div id="modal3" class="modal">
            <div class="modal-content content-done valign-wrapper">
                <!--<a href="#!" class="modal-action modal-close"><i class="material-icons close">close</i></a>-->
                <div class="row">            
                    <div class="col s12">
                        <div class="icon-donde"><img src="assets/images/logoLoad.png"></div>
                        <div class="progress">
                            <div class="indeterminate green accent-4"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <footer class="page-footer">
            <div class="footer-copyright">
                <div class="container">
                    © 2017 BankU                    
                </div>
            </div>
        </footer> 
        <!-- Modal Structure -->        
        <div id="info2" class="modal">
            <div class="modal-content">
                <h4 class="title-msg">Validación de datos</h4>
                <p class="txt-msg">Existen campos obligatorios que deben ser seleccionados.</p>
            </div>
            <div class="modal-footer">
                <a href="#!" class="modal-action modal-close waves-effect waves-green btn-flat">Aceptar</a>
            </div>
        </div>

        <script type="text/javascript" src="cordova.js"></script>
        <script type="text/javascript" src="index.js"></script>                     
        <!--Import jQuery before materialize.js-->
        <script type="text/javascript" src="assets/js/jquery-2.1.1.min.js"></script>
        <script type="text/javascript" src="assets/js/materialize.min.js"></script>
        <script type="text/javascript" src="assets/js/jquery.validate.min.js"></script>
        <script type="text/javascript" src="assets/js/numeral.min.js"></script>
        <script src="assets/js/socket.io.js"></script>
        <script type="text/javascript" src="assets/js/tools.js?v=1.0.0"></script>         
        <script type="text/javascript" src="assets/js/includes.js?v=1.0.0"></script>        
        <script type="text/javascript" src="assets/js/nouislider.min.js"></script> 
        <script type="text/javascript" src="assets/js/wNumb.js"></script>
        <script type="text/javascript">
         $( document ).ready(function(){            
            var socket = io('https://banku-services.herokuapp.com/');  
            var rand=  Math.random();         
            $("#id_u").val(localStorage.id_u);
            var type=3;
            if(localStorage.type_user=="prestatario")type=4;
            $("#type").val(type);
            getConfig();
            getOffertTemp();
            var saldo= parseInt(localStorage.saldo);           
            if(saldo<="0"){
                $('.title-msg').html('Monto mínimo de prestamos');
                $('.txt-msg').html('Aun no tiene cupo asignado de prestamo.<br/>Comuniquese con el administrador.');
                $(".configuration").hide();
                $('#info2').modal('open');
            }

            $( ".accent-4" ).click(function() {
                var monto= $("#monto").val();
                var interes= $("#interes").val();
                var duracion= $("#duracion").val();
                var motivo= $("#motivo").val();
                if(monto&&interes&&duracion&&motivo){
                    localStorage.setItem("amount",monto);
                    localStorage.setItem("duration",duracion);
                    localStorage.setItem("interest",interes);
                    $.ajax({
                        type: "POST",
                        url: "http://bankucolombia.com/lib/ajax_service_mobil.php",
                        data: $("#frm_register").serialize(),
                        dataType:'JSON',
                        success: function(msg){
                            $(".progress").show();
                            localStorage.setItem("set_offer","true");
                            var data = {page:"08_InvestmentsStep3.html?section=negociar&rand="+rand,action:"new_offer_prest",monto:$("#monto").val(),interes:$("#interes").val(),duracion:$("#duracion").val()};                    
                            socket.emit('setOffert', data);
                            $('#modal3').modal('open');
                            setTimeout(function(){ $('#modal3').modal('close');window.location = "10_LoansStep3.html?section=solicitar_dinero"; }, 2000);
                            Materialize.toast('Datos guardados exitosamente', 3000, 'rounded');
                        },
                        error: function(XMLHttpRequest, textStatus, errorThrown) { 
                            alert("Problemas procesando datos: " + textStatus +" - "+errorThrown);
                        }
                    });
                }else{
                    var top = $('.cuota').position().top;
                    $(window).scrollTop( top );
                    $("#motivo").addClass("error");
                    $('#info2').modal('open');
                }             
            });            
         });

        function getConfig(){
            $.ajax({
                type: "POST",
                url: "http://bankucolombia.com/lib/ajax_service_mobil.php",
                data: "action=getConfig&id_u="+localStorage.id_u,
                dataType:'JSON',
                success: function(msg){
                    if(msg.data!==null){
                        if(msg.data.amount)$("#monto").val(msg.data.amount);
                        if(msg.data.interest)$("#interes").val(msg.data.interest);
                        if(msg.data.duration)$("#duracion").val(msg.data.duration);
                        if(msg.data.destination){
                            $('#motivo option[value='+msg.data.destination+']').attr('selected','selected');
                            $('#motivo').material_select();   
                        }
                    }
                    setSliders();                
                    var cuota= calcCuota($("#monto").val(),$("#interes").val(),$("#duracion").val());
                    $(".cuota").html(numeral(cuota).format('0,0'));
                },
                error: function(XMLHttpRequest, textStatus, errorThrown) { 
                    alert("Problemas procesando datos: " + textStatus +" - "+errorThrown);
                }
            });             
        }
        function setSliders(){
            var saldo= parseInt(localStorage.saldo);
            var capital = document.getElementById('capital');
            var interest = document.getElementById('interest');
            var duration = document.getElementById('duration');
            var mount1= parseInt(localStorage.monto1);
            var mount2= parseInt(localStorage.monto2);
            var interes1= parseFloat(localStorage.interes1);
            var interes2= parseFloat(localStorage.interes2);        
            var duration1= parseInt(localStorage.duracion1);
            var duration2= parseInt(localStorage.duracion2);
            var monto= parseInt($("#monto").val());
            var interes= parseFloat($("#interes").val());
            var duracion= parseInt($("#duracion").val());
            var find = ["$","%","."];
            var replace = ['','',''];
            var max_monto= mount2;
            var cuota=0;
            if(saldo < mount2)max_monto= saldo;

            noUiSlider.create(capital, {
                start: [ monto ],
                connect: true,
                tooltips: [ true ],
                step: 100000,
                range: {
                    'min': mount1,
                    'max': max_monto
                },
                format: wNumb({
                    decimals: 0,
                    thousand: '.',
                    prefix: '$',
                })           
            });
            capital.noUiSlider.on('change', function(data){
                $("#monto").val(rplMoney(data.toString()));
                console.log(monto +" "+mount1+"  "+max_monto);
                cuota=calcCuota($("#monto").val(),$("#interes").val(),$("#duracion").val());
                $(".cuota").html(numeral(cuota).format('0,0'));
            });        
            noUiSlider.create(interest, {
                start: [ interes ],
                connect: true,
                tooltips: [ true ],
                range: {
                    'min': interes1,
                    'max': interes2
                },
                format: wNumb({
                    decimals: 2,
                    mark: '.',
                    suffix: '%',
                }) 
            });
            interest.noUiSlider.on('change', function(data){
                $("#interes").val(rplPerc(data.toString()));
                cuota=calcCuota($("#monto").val(),$("#interes").val(),$("#duracion").val());
                $(".cuota").html(numeral(cuota).format('0,0'));
            });        
            noUiSlider.create(duration, {
                start: [ duracion ],
                connect: true,
                tooltips: [ true ],
                range: {
                    'min': duration1,
                    'max': duration2
                },
                format: wNumb({
                    decimals: 0
                })             
            });
            duration.noUiSlider.on('change', function(data){
                $("#duracion").val(data.toString());
                cuota=calcCuota($("#monto").val(),$("#interes").val(),$("#duracion").val());
                $(".cuota").html(numeral(cuota).format('0,0'));
            });            
        }
  function getOffertTemp(){
      $.ajax({
        type: "POST",
        url: "http://bankucolombia.com/lib/ajax_service_mobil.php",
        data: "action=getOfferTemp&id_u="+localStorage.id_u+"&type_user="+localStorage.type_user,
        dataType:'JSON',
        success: function(msg){
          if(msg.data.length>0){
            $(".btn-find-proyects").html("<h4>No puede realizar cambios de configuración.</h4><h5>Existen negociaciones abiertas</h5>");
          }
        },
        error: function(XMLHttpRequest, textStatus, errorThrown) { 
          alert("Problemas procesando datos: " + textStatus +" - "+errorThrown);
        }
      });          
    }                                   
        </script>
    </body>
</html>