<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <!--Import Google Icon Font-->
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">

  <!--Import materialize.css-->
  <link type="text/css" rel="stylesheet" href="assets/css/materialize.min.css"  media="screen,projection"/>
  <!--Import my style-->
  <link type="text/css" href="assets/css/custom.css" rel="stylesheet"/>
  <link type="text/css" href="assets/css/nouislider.min.css" rel="stylesheet"/>
  <!--Let browser know website is optimized for mobile-->
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
</head>

<body class="profile settings-investment">
  <!--Nav Main-->
  <div class="navbar-fixed nav-descktop"></div>

  <!--Nav Responsive-->
  <nav class="nav-app">
    <div class="nav-wrapper">
      <a href="#!" class="brand-logo center">En negociación con <span class="negociando-con"></span></a>
      <ul class="left ">
        <li><a href="#!" class="back"><i class="material-icons">keyboard_arrow_left</i></a></li>
      </ul>
      <ul class="right ">
        <li><a href="#!" class="red-text tooltipped eliminar" data-position="top" data-delay="50" data-tooltip="Eliminar proyecto"><i class="material-icons small">cancel</i></a></li>
      </ul>
    </div>
  </nav>

  <div class="wrapper">
    <div class="container box-messages">
      <div class="row">
        <div class="col s12 pag-nav">
          <span class="btn-nav-pag">
            <a href="#!" class="btn grey lighten-1"><i class="material-icons left">&nbsp;</i>Volver</a>   
            <a href="10_LoansStep3.html" class="btn grey lighten-1">Buscar proyecto</a>                         
          </span>
        </div>
        <div class="col s12">    
          <h3 class="center hide-on-med-and-down names">En negociación con <span class="negociando-con"></span></h3>
          <br>
        </div>  

        <div class="col s12">
          <div class="col s12">
            <div class="box-proyect-nego">                    
              <div class="row">  
                <div class="col s7">
                  <div class="info-nego">
                    <h5 class="nombre-user"></h5>  
                    <p><span class="destination"></span><span class="interest"></span><span class="duration"></span></p> 
                    <div class="star-user"></div>
                  </div>                                                           
                </div> 
                <div class="col s5 right-align">                                 
                  <h3 class="amount"></h3>
                  <p><small>Pago Mensual: <span class="cuota"></span></small></p>                    
                </div>  
                <div class="col s12">
                  <input id="inv_b" name="inv_b" type="hidden" value="">
                  <input id="prest_b" name="prest_b" type="hidden" value="">                  
                  <input id="total_b" name="total_b" type="hidden" value="">
                  <input id="quota_b" name="quota_b" type="hidden" value="">
                  <input id="interes_b" name="interes_b" type="hidden" value="">
                  <input id="plazo_b" name="plazo_b" type="hidden" value="">
                  <input id="destination_b" name="destination_b" type="hidden" value="">
                  <input id="offer_b" name="offer_b" type="hidden" value="">
                  <hr style="width: 90%">
                </div>
              </div>                     
            </div>
          </div>

        </div>                     
      </div>
      <div class="chat"></div>
      <div class="clear"></div> 
    </div>                         

    <div class="box-businnes"> 
      <div class="btn-action-bussines">
        <a href="#modal3" class="btn-nego">Negociar</a>
        <a href="#!" class="btn-favorito">Favorito</a>
        <a href="#!" class="btn-aceptar">Aceptar</a>        
      </div>
      <div class="info-money">
        <strong class="negociaciones"></strong>
      </div> 
    </div>                                                                                

  </div>         

  <!-- Modal Structure Load -->
  <div id="modal3" class="modal">
    <a href="#!" class="modal-action modal-close"><i class="material-icons close">close</i></a>
    <div class="modal-content content-done valign-wrapper">  
      <div class="row">            
        <div class="col s12">
          <p>Configura las nuevas características para renegociar tu inversión.</p>  
          <div class="card-panel white">
            <h5 class="left"><small>Interes:</small> <strong>0,8 - 2,3 % E.M.</strong></h5>
          </div> 
          <div class="card-panel white">
            <p class="range-field"><div id="interest"></div></p> 
            <input type="hidden" id="monto" name="monto" value="">
            <input type="hidden" id="interes" name="interes" value="">             
            <input type="hidden" id="interesF" name="interesF" value="">
            <div class="clear"></div>  
          </div>
          <div class="card-panel white"> 
            <h5 class="left"><small>Duración:</small> <strong>0 - 12 Meses</strong></h5>
          </div>
          <div class="card-panel white">
            <p class="range-field"><div id="duration"></div></p>
            <input type="hidden" id="duracion" name="duracion" value=""> 
            <input type="hidden" id="duracionF" name="duracionF" value="">
            <div class="clear"></div>    
          </div>

        </div>

        <div class="col s12 center payment-month">
          <p>Pago (mes)</p>
          <h2>$<span class="cuotaSlider"></span></h2>
        </div>

        <div class="col s12 center margin-top-40 btn-register">
          <a class="waves-effect waves-light green accent-4 btn-large negociar">Negociar</a>
        </div>                    
      </div>
    </div>  
  </div>

  <!-- Modal Structure Agree -->
  <div id="info2" class="modal">
    <div class="modal-content">
      <h4>Adcionar Favoritos</h4>
      <p>La negociación ha sido adicionada a favoritos.</p>
    </div>
    <div class="modal-footer">
      <a href="#!" class="modal-action modal-close waves-effect waves-green btn-flat">Aceptar</a>
    </div>
  </div>  
  <div id="modal4" class="modal">
    <a href="#!" class="modal-action modal-close"><i class="material-icons close">close</i></a>
    <div class="modal-content content-done valign-wrapper">            
      <div class="container">                
        <div class="icon-donde"><i class="material-icons done">done</i></div>
        <h4>En hora buena!</h4>
        <p>Trato aceptado con <span class="negociando-con"></span></p>
        <hr>
        <div class="row">
          <div class="col s8"> 
            <div class="info-nego left-align"> 
              <p><span class="destination"></span></p> 
            </div>                                                           
          </div> 
          <div class="col s4 right-align">                           
            <p><strong><small>Pago Mensual: </small><br>
              $<span class="f_cuota"></span></strong></p>              
            </div> 
          </div>
        </div>
      </div>
    </div>

    <footer class="page-footer">
      <div class="footer-copyright">
        <div class="container">
          © 2017 BankU                    
        </div>
      </div>
    </footer>           
    <script type="text/javascript" src="cordova.js"></script>
    <script type="text/javascript" src="index.js"></script> 
    <!--Import jQuery before materialize.js-->
    <script type="text/javascript" src="assets/js/jquery-2.1.1.min.js"></script>
    <script type="text/javascript" src="assets/js/materialize.min.js"></script>
    <script type="text/javascript" src="assets/js/jquery.validate.min.js"></script>
    <script type="text/javascript" src="assets/js/numeral.min.js"></script>
    <script src="assets/js/socket.io.js"></script>
    <script type="text/javascript" src="assets/js/tools.js?v=1.0.0"></script>         
    <script type="text/javascript" src="assets/js/includes.js?v=1.0.0"></script> 
    <script type="text/javascript" src="assets/js/nouislider.min.js"></script> 
    <script type="text/javascript" src="assets/js/wNumb.js"></script>     
    <script type="text/javascript">
     $( document ).ready(function(){      
      const socket = io('https://banku-services.herokuapp.com/');
      $('.tooltipped').tooltip({delay: 50});
      $(".wrapper").show();
      var id_ofert= getUrlParameter("id_ofert");
      var negociando= getUrlParameter("negociando");
      getFavorite(id_ofert,localStorage.id_u,localStorage.type_user);       
      $( ".btn-aceptar" ).click(function() {
        var monto= $("#total_b").val();
        var interes= $("#interes_b").val();
        if($(".l_interes").first().html())interes= $(".l_interes").first().html();
        var duracion= $("#plazo_b").val();
        if($(".l_duracion").first().html())duracion= $(".l_duracion").first().html();
        var cuota= calcCuota(monto,interes,duracion);

        $(".f_cuota").html(numeral(cuota).format('0,0'));
        $('#modal4').modal('open');

        $.ajax({
          type: "POST",
          url: "http://bankucolombia.com/lib/ajax_service_mobil.php",
          data: "action=setOfferFinal&inv_b="+$("#inv_b").val()+"&prest_b="+localStorage.id_u+"&total_b="+monto+"&quota_b="+cuota+"&interes_b="+interes+"&plazo_b="+duracion+"&destination_b="+$("#destination_b").val()+"&offer_b="+id_ofert+"&admin="+localStorage.id_u,
          dataType:'JSON',
          success: function(msg){  
            if(msg.status){
                $.ajax({
                  type: "POST",
                  url: "http://bankucolombia.com/lib/ajax_service_mobil.php",
                  data: "action=setPaysxBusiness&fecha="+localStorage.fecha+"&prest="+$("#prest_b").val()+"&monto="+$("#total_b").val()+"&quota_b="+$("#quota_b").val()+"&tasa1="+$("#interes_b").val()+"&meses="+$("#plazo_b").val()+"&id_b="+msg.id_b,
                  dataType:'JSON',
                  success: function(msg){
                    if(msg.status){
                      var obj = jQuery.parseJSON ( getOnline($("#prest_b").val()) );
                      if(obj.online=="0"){
                        sendPushMessage(obj.pushtoken,"Aceptación de negociación en el sistema BankU.");
                        }else{                        
                        var data = {page:"11_EarningsStep2.html?section=mis_ganancias&msg=aceptada",action:"new_business",id_u:$("#inv_b").val()};                    
                        socket.emit('setOffert', data);                          
                        }                                 
                      setTimeout(function(){ $('#modal4').modal('close');window.location.href = "12_PaymentsStep1.html?section=mis_pagos"; }, 1500);              
                    }
                  }
                });             
            }
          }
        });
      });      
      $( ".eliminar" ).click(function() {
        var conf=confirm("¿Está seguro de que desea eliminar esta negociación?");
        if(conf){
          $.ajax({
            type: "POST",
            url: "http://bankucolombia.com/lib/ajax_service_mobil.php",
            data: "action=delOfferMatch&prest="+localStorage.id_u+"&id="+id_ofert+"&owner_offer="+$("#inv_b").val(),
            dataType:'JSON',
            success: function(msg){  
              if(msg.status){
                var data = {page:"08_InvestmentsStep3.html?section=negociar",action:"del_offert",id_ofert:id_ofert,id_u:$("#inv_b").val()};                    
                socket.emit('setOffert', data);
                window.location.href = "08_InvestmentsStep3.html?section=negociar";
              }
            }
          });          
        }
      });
      $( ".btn-favorito" ).click(function() {
        $.ajax({
          type: "POST",
          url: "http://bankucolombia.com/lib/ajax_service_mobil.php",
          data: "action=setFavorite&admin="+localStorage.id_u+"&inv="+localStorage.id_u+"&prest="+$("#prest_b").val()+"&id="+id_ofert,
          dataType:'JSON',
          success: function(msg){  
            if(msg.status){
              $(".btn-favorito").css("background-position","right -2px bottom 21px").css("color","#fed22c");
              $('#info2').modal('open');
            }
          }
        });
      });      
      $( ".negociar" ).click(function() {
        var monto= $("#monto").val();
        var interes= $("#interes").val();
        var duracion= $("#duracion").val();         
        var inv_b= $("#inv_b").val(); 
        if(monto!=""&&interes!=""&&duracion!=""){
          var setoffer= setOfferTemp(id_ofert,inv_b,localStorage.id_u,interes,duracion);
          if(setoffer){
            $(".btn-nego").hide();
            $('#modal3').modal('close');
            var data = {page:"08_InvestmentsStep4.html?id_ofert="+id_ofert+"&negociando=true",action:"chat",id_u:inv_b};
            socket.emit('setOffert',data);
            var obj = jQuery.parseJSON ( getOnline(inv_b) );
            if(obj.online=="0")sendPushMessage(obj.pushtoken,"Nueva negociación en el sistema.");
            getOffersTemp(id_ofert);
          }
        }
      }); 

      if(id_ofert){
        getHeaderOffert(id_ofert);
        getOffersTemp(id_ofert);
        setTimeout(function(){
          if($(".l_interes").html())$("#interesF").val($(".l_interes").html());
          if($(".l_plazo").html())$("#duracionF").val($(".l_plazo").html());
          if($(".user_id").attr("data-id")&&$(".user_id").attr("data-id")==localStorage.id_u)$(".btn-nego").hide();
          setSliders();
        },1000);        
      }              
    })
     function setSliders(){
      var monto= $("#monto").val();
      var interes= $("#interes").val();
      if($("#interesF").val()!="")interes= $("#interesF").val();
      var duracion= $("#duracion").val();
      if($("#duracionF").val()!="")duracion= $("#duracionF").val();
      var cuota= calcCuota(monto,interes,duracion);
      $(".cuotaSlider").html(numeral(cuota).format('0,0')); 
        
      var find = ["$","%","."];
      var replace = ['','',''];
      noUiSlider.create(interest, {
        start: [ interes ],
        connect: true,
        tooltips: [ true ],
        range: {
          'min': parseFloat(localStorage.interes1),
          'max': parseFloat(localStorage.interes2)
        },
        format: wNumb({
          decimals: 2,
          mark: '.',
          suffix: '%',
        }) 
      });
      interest.noUiSlider.on('change', function(data){
        $(".cuota").html("0");
        if(monto!=""&&interes!=""&&duracion!=""&&monto!="0"&&interes!="0"&&duracion!="0"){
          var duracion= duration.noUiSlider.get();
          var interes= rplPerc(data.toString());
          $("#interes").val(interes);
          var cuota= calcCuota(monto,interes,duracion);
          $(".cuotaSlider").html(numeral(cuota).format('0,0'));
        }
      });        
      noUiSlider.create(duration, {
        start: [ duracion ],
        connect: true,
        tooltips: [ true ],
        range: {
          'min': parseInt(localStorage.duracion1),
          'max': parseInt(localStorage.duracion2)
        },
        format: wNumb({
          decimals: 0
        })             
      });
      duration.noUiSlider.on('change', function(data){
        $(".cuota").html("0");
        if(monto!=""&&interes!=""&&duracion!=""&&monto!="0"&&interes!="0"&&duracion!="0"){          
          var duracion= data.toString();
          $("#duracion").val(duracion);
          var interes= rplPerc(interest.noUiSlider.get());
          var cuota= calcCuota(monto,interes,duracion);
          $(".cuotaSlider").html(numeral(cuota).format('0,0'));
        }
      });            
    } 
function getHeaderOffert(id_ofert){
         $.ajax({
            type: "POST",
            url: "http://bankucolombia.com/lib/ajax_service_mobil.php",
            data: "action=getHeaderOffert&id_ofert="+id_ofert,
            dataType:'JSON',
            success: function(msg){    
              if(msg.status&&msg.data){
                $.each(msg.data, function( index, value ) {
                var monto= parseInt(localStorage.amount);
                var interes= parseFloat(value.interest2);
                var duracion= parseInt(localStorage.duration);
                if(localStorage.id_u==value.id_u){
                  monto= parseInt(value.amount);
                  interes= parseFloat(value.interest);
                  $("#prest_b").val(localStorage.id_u);                 
                }else{
                  if(parseInt(localStorage.amount) > parseInt(value.amount2))monto= parseInt(value.amount2);
                  if(parseInt(localStorage.duration)<parseInt(value.duration) || parseInt(localStorage.duration)>parseInt(value.duration2))duracion= parseInt(value.duration2);
                }
                
                  if(localStorage.id_u!=value.id_u){
                    $(".negociando-con").html(value.user_u);
                    $("#inv_b").val(value.id_u);
                    $(".avatar-nego").hide();                    
                    $("#prest_b").val(localStorage.id_u);                    
                  }
                  $(".nombre-user").html(value.user_u); 
                  var starts= getStarts(value.calification2_u);
                  $(".star-user").html(starts);
                  var cuota= calcCuota(monto,interes,duracion);
                  var calification= value.calification;
                                   
                  if(localStorage.type_user!="prestatario"&&value.ldestination)$(".destination").html(value.ldestination+'<br>');
                  $(".interest").html(interes+'% | ');
                  $(".duration").html(duracion+' Meses');
                  $(".amount").html("$"+numeral(monto).format('0,0'));
                  $(".cuota").html("$"+numeral(cuota).format('0,0'));
                  $("#monto").val(monto);
                  $("#interes").val(interes);
                  $("#duracion").val(duracion);
                  $("#total_b").val(monto);
                  $("#quota_b").val(cuota);
                  $("#destination_b").val(value.destination);                  
                  $("#interes_b").val(interes);
                  $("#plazo_b").val(duracion);
                  $("#offer_b").val(id_ofert);                                     
                });
              }
            }
          });  
}                 
  </script>
</body>
</html>